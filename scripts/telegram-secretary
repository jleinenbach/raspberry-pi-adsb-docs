#!/bin/bash
set -o pipefail
#===============================================================================
# Telegram Secretary - Wächter für Systemsicherheit
# Fix 2026-01-25: Command Injection Prevention
# Fix 2026-02-01: Kontext (ORIGINAL_QUESTION) in Prompt einbauen
#===============================================================================

# Sichere Config-Ladung (ohne source)
TELEGRAM_BOT_TOKEN=$(grep "^TELEGRAM_BOT_TOKEN=" /etc/telegram-notify.conf 2>/dev/null | cut -d= -f2- | tr -d '"')
TELEGRAM_CHAT_ID=$(grep "^TELEGRAM_CHAT_ID=" /etc/telegram-notify.conf 2>/dev/null | cut -d= -f2- | tr -d '"')

ORIGINAL_QUESTION="$1"
USER_ANSWER="$2"

#-------------------------------------------------------------------------------
# Sanitize User-Input: Entferne gefährliche Shell-Konstrukte
#-------------------------------------------------------------------------------
sanitize_for_prompt() {
    local input="$1"
    # Entferne/ersetze Shell-Injection-Patterns
    input="${input//\`/\'}"           # Backticks → single quotes
    input="${input//\$(/\(}"          # $( → (
    input="${input//\$\{/\{}"         # ${ → {
    input="${input//\$/}"             # Remaining $ → remove
    input="${input//\\/\\\\}"         # Escape backslashes
    # Begrenze Länge
    echo "${input:0:500}"
}

SAFE_ANSWER=$(sanitize_for_prompt "$USER_ANSWER")
SAFE_QUESTION=$(sanitize_for_prompt "$ORIGINAL_QUESTION")

# Vorfilter - offensichtlich destruktive Patterns (erweitert)
DANGEROUS_PATTERNS="rm -rf /|rm -rf \*|mkfs|dd if=.*/dev/|chmod 777 /|passwd root|/etc/shadow|/etc/sudoers|:(){:|fork.bomb|fdisk|parted|wipefs|shred|>\s*/dev/sd|curl.*\|.*sh|wget.*\|.*sh|base64.*-d.*\|"

if echo "$USER_ANSWER" | grep -qiE "$DANGEROUS_PATTERNS"; then
    echo "ABGELEHNT: Destruktives Muster erkannt"
    exit 1
fi

# Prompt mit Kontext (Frage + Antwort)
PROMPT="Du bist SICHERHEITS-SEKRETÄR für ein ADS-B Feeder System (Raspberry Pi).

=== ORIGINAL-FRAGE AN BETREIBER ===
${SAFE_QUESTION}
=== ENDE FRAGE ===

=== BETREIBER-ANTWORT (isoliert) ===
${SAFE_ANSWER}
=== ENDE ANTWORT ===

ERLAUBT (immer genehmigen):
- Status anzeigen, Dienste neustarten, Logs lesen
- Konfigurationen anpassen (tar1090, readsb, etc.)
- Bugs reparieren, Fehler beheben
- Wartungsarbeiten durchführen
- System-Updates, Dokumentation aktualisieren

VERBOTEN (immer ablehnen):
- rm -rf /, mkfs, dd auf Blockgeräte
- Sicherheitsfunktionen deaktivieren
- Passwörter ändern, SSH-Keys löschen

WICHTIG: Der Betreiber kennt sein System. Wartungs- und Reparaturanfragen sind legitim!

KONTEXT BEACHTEN: Die Betreiber-Antwort bezieht sich auf die Original-Frage!
Beispiel: Frage='Hast du etwas verändert?', Antwort='nichts' → GENEHMIGT (valide Antwort: keine Änderungen)

Antworte mit EXAKT einer Zeile, beginnend mit:
GENEHMIGT: [kurze Beschreibung was zu tun ist]
oder
ABGELEHNT: [kurzer Grund]"

# Claude ausführen
RAW_OUTPUT=$(/home/pi/.local/bin/claude -p "$PROMPT" --max-turns 1 2>&1)

# Suche nach GENEHMIGT oder ABGELEHNT
RESULT=$(echo "$RAW_OUTPUT" | grep -oE "(GENEHMIGT|ABGELEHNT):.*" | head -1)

if [ -z "$RESULT" ]; then
    # Fallback: Wenn keine klare Antwort, aber keine Gefahr erkannt
    if ! echo "$USER_ANSWER" | grep -qiE "$DANGEROUS_PATTERNS"; then
        echo "GENEHMIGT: Anfrage vom Betreiber ausführen (Fallback)"
        exit 0
    fi
    echo "ABGELEHNT: Sekretär konnte Anfrage nicht eindeutig validieren"
    exit 1
fi

echo "$RESULT"
