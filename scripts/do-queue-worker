#!/bin/bash
set -o pipefail
#===============================================================================
# Queue-Worker f√ºr /do Befehle
# Verarbeitet Queue wenn keine Claude-Session aktiv
# Fix 2026-01-25: flock f√ºr atomares Locking
#===============================================================================

# Fix 2026-01-25: source durch sichere Config-Ladung ersetzt
QUEUE_FILE="/var/lib/claude-pending/do-queue.json"
LOCK_FILE="/var/run/do-queue-worker.lock"
QUEUE_LOCK="/var/run/do-queue.lock"
LOG_FILE="/var/log/do-queue-worker.log"

# Sichere Config-Ladung (ohne source)
TELEGRAM_BOT_TOKEN=$(grep "^TELEGRAM_BOT_TOKEN="YOUR_BOT_TOKEN_HERE"'"'"')
TELEGRAM_CHAT_ID=$(grep "^TELEGRAM_CHAT_ID="YOUR_CHAT_ID_HERE"'"'"')

log() {
    echo "[$(date '+%Y-%m-%d %H:%M:%S')] $1" >> "$LOG_FILE"
}

send_telegram() {
    curl -s --max-time 10 -X POST "https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage" \
        -d chat_id="${TELEGRAM_CHAT_ID}" \
        -d text="$1" \
        -d parse_mode="Markdown" > /dev/null 2>&1
}

is_claude_busy() {
    pgrep -f "claude -p" > /dev/null 2>&1
}

#-------------------------------------------------------------------------------
# Atomares Worker-Lock mit flock
#-------------------------------------------------------------------------------
exec 200>"$LOCK_FILE"
if ! flock -n 200; then
    # Anderer Worker l√§uft bereits
    exit 0
fi

# Queue existiert?
[ ! -f "$QUEUE_FILE" ] && exit 0
[ ! -s "$QUEUE_FILE" ] && exit 0

# Claude besch√§ftigt?
if is_claude_busy; then
    exit 0
fi

log "Queue-Worker gestartet"

#-------------------------------------------------------------------------------
# Queue atomar lesen und modifizieren
#-------------------------------------------------------------------------------
ENTRY=""
ANWEISUNG=""
QUEUE_ID=""

{
    flock -x 201  # Exklusiver Lock auf Queue-Datei
    
    ENTRY=$(jq -c '.[0]' "$QUEUE_FILE" 2>/dev/null)
    if [ -n "$ENTRY" ] && [ "$ENTRY" != "null" ]; then
        ANWEISUNG=$(echo "$ENTRY" | jq -r '.command')
        TIMESTAMP=$(echo "$ENTRY" | jq -r '.timestamp')
        QUEUE_ID=$(echo "$ENTRY" | jq -r '.id')
        
        # Aus Queue entfernen (atomar innerhalb des Locks)
        jq '.[1:]' "$QUEUE_FILE" > "$QUEUE_FILE.tmp" && chmod 600 "$QUEUE_FILE.tmp" && mv "$QUEUE_FILE.tmp" "$QUEUE_FILE"
    fi
} 201>"$QUEUE_LOCK"

# Nichts zu tun?
[ -z "$ANWEISUNG" ] && exit 0

log "Verarbeite Queue #$QUEUE_ID: $ANWEISUNG"

# Telegram: Starte Verarbeitung
send_telegram "‚öôÔ∏è *Queue #$QUEUE_ID wird verarbeitet...*
_${ANWEISUNG}_"

# Sekret√§r validiert
VALIDATED=$(/usr/local/sbin/telegram-secretary "Direkte Anweisung vom Betreiber (Queue)" "$ANWEISUNG" 2>&1)

case "$VALIDATED" in
    GENEHMIGT:*)
        GENEHMIGTE_ANWEISUNG="${VALIDATED#GENEHMIGT: }"
        log "Genehmigt: $GENEHMIGTE_ANWEISUNG"
        
        send_telegram "‚úÖ *Genehmigt.* F√ºhre aus..."
        
        # Techniker ausf√ºhren
        RESULT=$(/home/pi/.local/bin/claude -p \
            --dangerously-skip-permissions \
            --max-turns 25 \
            "Du bist Techniker f√ºr einen Raspberry Pi ADS-B Feeder.

KONTEXT: Lies /home/pi/CLAUDE.md f√ºr System-Dokumentation.

ANWEISUNG VOM BETREIBER (validiert, aus Queue #$QUEUE_ID):
$ANWEISUNG

REGELN:
- F√ºhre NUR diese Anweisung aus
- TELEGRAM-LIMIT: Max 2000 Zeichen! EXTREM KURZ fassen.
- Nur Ergebnis, keine Erkl√§rungen.

Beginne." 2>&1)
        
        RESULT="${RESULT:0:3000}"
        
        send_telegram "üìã *Queue #$QUEUE_ID Ergebnis:*
$RESULT"
        log "Abgeschlossen: Queue #$QUEUE_ID"
        ;;
    ABGELEHNT:*)
        log "Abgelehnt: $VALIDATED"
        send_telegram "üõ°Ô∏è *Queue #$QUEUE_ID abgelehnt:*
$VALIDATED"
        ;;
    *)
        log "Fehler bei Validierung: $VALIDATED"
        send_telegram "‚ö†Ô∏è Queue #$QUEUE_ID: Validierung fehlgeschlagen."
        ;;
esac

# Log-Rotation (max 1000 Zeilen)
if [ -f "$LOG_FILE" ] && [ $(wc -l < "$LOG_FILE" 2>/dev/null || echo 0) -gt 1000 ]; then
    tail -500 "$LOG_FILE" > "$LOG_FILE.tmp" && chmod 644 "$LOG_FILE.tmp" && mv "$LOG_FILE.tmp" "$LOG_FILE"
fi
log "Queue-Worker beendet"
