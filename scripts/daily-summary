#!/bin/bash
set -o pipefail
#===============================================================================
# TÃ¤gliche Zusammenfassung vor Claude-Wartung
# LÃ¤uft um 06:55, sendet Status via Telegram
#===============================================================================

# Fix 2026-01-25: source durch sichere Config-Ladung ersetzt
# Sichere Config-Ladung (ohne source)
TELEGRAM_BOT_TOKEN=$(grep "^TELEGRAM_BOT_TOKEN=" /etc/telegram-notify.conf 2>/dev/null | cut -d= -f2- | tr -d '"')
TELEGRAM_CHAT_ID=$(grep "^TELEGRAM_CHAT_ID=" /etc/telegram-notify.conf 2>/dev/null | cut -d= -f2- | tr -d '"')

# Uptime
UPTIME=$(uptime -p | sed 's/up //')

# RAM
RAM_PCT=$(free | awk '/Mem:/ {printf "%.0f", $3/$2*100}')

# CPU Temperatur
TEMP=$(vcgencmd measure_temp 2>/dev/null | grep -oP "[0-9.]+" || echo "?")


# SpannungsÃ¼berwachung
THROTTLED=$(vcgencmd get_throttled 2>/dev/null | cut -d= -f2)
THROTTLED="${THROTTLED:-0x0}"
THROTTLED_DEC=$((THROTTLED))
VOLT_BIT0=$((THROTTLED_DEC & 0x1))
VOLT_BIT16=$((THROTTLED_DEC & 0x10000))
VOLT_ICON="ðŸŸ¢"
VOLT_STATUS="OK"
if [ "$THROTTLED" = "0x0" ]; then
    VOLT_ICON="ðŸŸ¢"
    VOLT_STATUS="Stabil"
elif [ "$VOLT_BIT0" -eq 1 ]; then
    VOLT_ICON="ðŸ”´"
    VOLT_STATUS="UNTERSPANNUNG!"
elif [ "$VOLT_BIT16" -ne 0 ]; then
    VOLT_ICON="ðŸŸ¡"
    VOLT_STATUS="War niedrig"
fi

# NTP Zeitsynchronisation (seit 2026-01-31 optimiert)
NTP_TRACKING=$(chronyc tracking 2>/dev/null)
NTP_SYS_TIME=$(echo "$NTP_TRACKING" | grep "System time" | grep -oP '[0-9.]+' | head -1)
NTP_RMS=$(echo "$NTP_TRACKING" | grep "RMS offset" | grep -oP '[0-9.]+' | head -1)
NTP_UPDATE=$(echo "$NTP_TRACKING" | grep "Update interval" | grep -oP '[0-9.]+' | head -1)
NTP_REF=$(echo "$NTP_TRACKING" | grep "Reference ID" | grep -oP '\(.*?\)' | tr -d '()')

# Konvertiere zu Î¼s (Mikrosekunden) fÃ¼r bessere Lesbarkeit
if [ -n "$NTP_SYS_TIME" ]; then
    NTP_SYS_US=$(awk "BEGIN {printf \"%.0f\", $NTP_SYS_TIME * 1000000}")
else
    NTP_SYS_US="?"
fi
if [ -n "$NTP_RMS" ]; then
    NTP_RMS_US=$(awk "BEGIN {printf \"%.0f\", $NTP_RMS * 1000000}")
else
    NTP_RMS_US="?"
fi

# Icon basierend auf Genauigkeit
NTP_ICON="ðŸŸ¢"
if [ "$NTP_SYS_US" != "?" ] && [ "$NTP_SYS_US" -gt 500 ]; then
    NTP_ICON="ðŸŸ¡"
fi
if [ "$NTP_SYS_US" != "?" ] && [ "$NTP_SYS_US" -gt 1000 ]; then
    NTP_ICON="ðŸ”´"
fi

# Service Status (20 Services nach Kategorien)
SERVICE_OK=0
SERVICE_FAIL=""
for svc in readsb piaware fr24feed adsbexchange-feed adsbexchange-mlat adsbexchange-stats tar1090 graphs1090 adsbfi-feed adsbfi-mlat opensky-feeder theairtraffic-feed rbfeeder airplanes-feed airplanes-mlat pfclient mlathub ogn-rf-procserv ogn-decode-procserv ogn2dump1090 dragonsync; do
    if systemctl is-active "$svc" &>/dev/null; then
        ((SERVICE_OK++))
    else
        SERVICE_FAIL+=" ${svc%%-*}"
    fi
done
SERVICE_TOTAL=21

# Watchdog Eskalationen und Reparaturen (letzte 24h)
# Berechne Zeitstempel von vor 24 Stunden
YESTERDAY=$(date -d "24 hours ago" "+%Y-%m-%d %H:%M:%S")
# ZÃ¤hle nur Zeilen mit Zeitstempel >= gestern
ESCALATIONS=$(awk -v cutoff="$YESTERDAY" '$0 ~ /^\[/ { ts=substr($0,2,19); if (ts >= cutoff && /ESKALATION/) count++ } END { print count+0 }' /var/log/feeder-watchdog.log 2>/dev/null)
REPAIRS=$(awk -v cutoff="$YESTERDAY" '$0 ~ /^\[/ { ts=substr($0,2,19); if (ts >= cutoff && /erfolgreich neugestartet/) count++ } END { print count+0 }' /var/log/feeder-watchdog.log 2>/dev/null)

# Statistiken
if [ -f /run/readsb/stats.json ]; then
    TRACKS=$(jq -r '.total.tracks.all // 0' /run/readsb/stats.json 2>/dev/null)
    MAX_RANGE=$(jq -r '.total.max_distance // 0' /run/readsb/stats.json 2>/dev/null)
    MAX_RANGE=$((MAX_RANGE / 1852))
else
    TRACKS="?"
    MAX_RANGE="?"
fi

# CVEs mit verfÃ¼gbaren Fixes
CVES=$(debsecan --suite bookworm --only-fixed 2>/dev/null | wc -l)
# OGN Statistiken
if systemctl is-active ogn-decode-procserv &>/dev/null; then
    OGN_HTML=$(curl -s http://localhost:8081/status.html 2>/dev/null)
    OGN_12H=$(echo "$OGN_HTML" | grep -oP 'Aircrafts received over last 12 hours.*?<b>\s*\K[0-9]+' | head -1)
    [ -z "$OGN_12H" ] && OGN_12H=0
else
    OGN_12H=0
fi

# Drohnen Statistiken
if systemctl is-active dragonsync &>/dev/null; then
    DRONES_24H=$(sudo journalctl -u dragonsync --since "24 hours ago" --no-pager 2>/dev/null | grep -oP 'mac.*?[0-9a-f:]{17}' | sort -u | wc -l 2>/dev/null || echo "0")
else
    DRONES_24H=0
fi

# Session-Status
SESSION_INFO=""
if [ -f /var/lib/claude-pending/session.json ]; then
    QUESTION=$(jq -r '.question' /var/lib/claude-pending/session.json 2>/dev/null | head -c 50)
    if [ -n "$QUESTION" ]; then
        SESSION_INFO="

â³ *Offene Frage:* ${QUESTION}..."
    fi
fi

# Status-Icons
SERVICE_ICON="ðŸŸ¢"
[ "$SERVICE_OK" -lt "$SERVICE_TOTAL" ] && SERVICE_ICON="ðŸŸ¡"
[ "$SERVICE_OK" -lt 14 ] && SERVICE_ICON="ðŸ”´"

CVE_ICON="ðŸŸ¢"
[ "$CVES" -gt 0 ] && CVE_ICON="ðŸŸ¡"
[ "$CVES" -gt 5 ] && CVE_ICON="ðŸ”´"

ESC_ICON="ðŸŸ¢"
[ "$ESCALATIONS" -gt 0 ] && ESC_ICON="ðŸ”´"

MESSAGE="ðŸ“Š *TÃ¤glicher Bericht* (vor Wartung)

*System*
â± Uptime: ${UPTIME}
ðŸ’¾ RAM: ${RAM_PCT}%
ðŸŒ¡ Temp: ${TEMP}Â°C
${VOLT_ICON} Spannung: ${VOLT_STATUS}

*NTP Zeitsync*
${NTP_ICON} Offset: ${NTP_SYS_US}Î¼s (RMS: ${NTP_RMS_US}Î¼s)
ðŸ”„ Update: ${NTP_UPDATE}s | ðŸ“¡ ${NTP_REF}

*Services* (${SERVICE_OK}/${SERVICE_TOTAL})
${SERVICE_ICON} $([ -z "$SERVICE_FAIL" ] && echo "Alle aktiv" || echo "Fehlt:$SERVICE_FAIL")

*Letzte 24h*
ðŸ”§ Reparaturen: ${REPAIRS}
${ESC_ICON} Eskalationen: ${ESCALATIONS}

*Statistiken*
âœˆï¸ Flugzeuge gesamt: ${TRACKS}
ðŸ“¡ Max Reichweite: ${MAX_RANGE} nm
ðŸª‚ OGN gesamt (12h): ${OGN_12H}
ðŸš Drohnen (24h): ${DRONES_24H}

*Sicherheit*
${CVE_ICON} CVEs mit Fix: ${CVES}${SESSION_INFO}

_Claude-Wartung startet in 5 min..._"

curl -s --max-time 10 -X POST "https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage" \
    -d chat_id="${TELEGRAM_CHAT_ID}" \
    -d text="${MESSAGE}" \
    -d parse_mode="Markdown" > /dev/null 2>&1
