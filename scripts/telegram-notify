#!/bin/bash
set -o pipefail
#===============================================================================
# Telegram Notification Script - MarkdownV2 (2026-01-31)
# Ref: https://core.telegram.org/bots/api#markdownv2-style
#===============================================================================

CONFIG_FILE="/etc/telegram-notify.conf"

if [ ! -f "$CONFIG_FILE" ]; then
    echo "Fehler: $CONFIG_FILE nicht gefunden" >&2
    exit 1
fi

# Sichere Config-Ladung
TELEGRAM_BOT_TOKEN=$(grep "^TELEGRAM_BOT_TOKEN=" "$CONFIG_FILE" 2>/dev/null | cut -d= -f2- | tr -d '"')
TELEGRAM_CHAT_ID=$(grep "^TELEGRAM_CHAT_ID=" "$CONFIG_FILE" 2>/dev/null | cut -d= -f2- | tr -d '"')

MESSAGE="$1"

# MarkdownV2 Escaping fÃ¼r Sonderzeichen
# Escape: _ * [ ] ( ) ~ ` > # + - = | { } . !
escape_markdownv2() {
    local text="$1"
    # Backslash ZUERST escapen
    text="${text//\\/\\\\}"
    # Dann alle anderen Sonderzeichen
    text="${text//_/\\_}"
    text="${text//\*/\\*}"
    text="${text//[/\\[}"
    text="${text//]/\\]}"
    text="${text//(/\\(}"
    text="${text//)/\\)}"
    text="${text//~/\\~}"
    text="${text//\`/\\\`}"
    text="${text//>/\\>}"
    text="${text//#/\\#}"
    text="${text//+/\\+}"
    text="${text//-/\\-}"
    text="${text//=/\\=}"
    text="${text//|/\\|}"
    text="${text//\{/\\\{}"
    text="${text//\}/\\\}}"
    text="${text//./\\.}"
    text="${text//!/\\!}"
    echo "$text"
}

# Escape die Nachricht
ESCAPED_MESSAGE=$(escape_markdownv2 "$MESSAGE")

# Sende mit MarkdownV2
curl -s --max-time 10 \
    --data-urlencode "chat_id=${TELEGRAM_CHAT_ID}" \
    --data-urlencode "text=${ESCAPED_MESSAGE}" \
    --data-urlencode "parse_mode=MarkdownV2" \
    "https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage" \
    > /dev/null 2>&1

exit $?
