#!/bin/bash
set -o pipefail
#===============================================================================
# Telegram Notification Script fÃ¼r ADS-B Feeder
# Usage: telegram-notify "Nachricht"
#        telegram-notify --error "Fehlermeldung"  
#        telegram-notify --success "Erfolgsmeldung"
#===============================================================================

# Fix 2026-01-25: source durch sichere Config-Ladung ersetzt
CONFIG_FILE="/etc/telegram-notify.conf"

if [ ! -f "$CONFIG_FILE" ]; then
    echo "Fehler: $CONFIG_FILE nicht gefunden" >&2
    exit 1
fi

# Sichere Config-Ladung (ohne source)
TELEGRAM_BOT_TOKEN=$(grep "^TELEGRAM_BOT_TOKEN="YOUR_BOT_TOKEN_HERE"$CONFIG_FILE" 2>/dev/null | cut -d= -f2- | tr -d '"')
TELEGRAM_CHAT_ID=$(grep "^TELEGRAM_CHAT_ID="YOUR_CHAT_ID_HERE"$CONFIG_FILE" 2>/dev/null | cut -d= -f2- | tr -d '"')

# Emoji basierend auf Typ
case "$1" in
    --error)
        PREFIX="ðŸ”´"
        shift
        ;;
    --success)
        PREFIX="âœ…"
        shift
        ;;
    --warning)
        PREFIX="âš ï¸"
        shift
        ;;
    --info)
        PREFIX="â„¹ï¸"
        shift
        ;;
    *)
        PREFIX="ðŸ“¡"
        ;;
esac

MESSAGE="$PREFIX *ADS-B Feeder*
$1"

# Sende Nachricht
curl -s --max-time 10 -X POST "https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage" \
    -d chat_id="${TELEGRAM_CHAT_ID}" \
    -d text="${MESSAGE}" \
    -d parse_mode="Markdown" \
    > /dev/null 2>&1

exit $?
